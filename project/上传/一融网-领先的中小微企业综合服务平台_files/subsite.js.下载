$(function(){
    var json_data = '';
    search_plstform();
    // 地区选择
    $('#nav_province').on('change', function () {
        set_city_select();
        search_plstform();
    });
    $('#nav_city').on('change', function () {
        set_area_select();
        search_plstform();
    });
    $('#nav_area').on('change', function () {
        search_plstform();
    });
    $('#pf_search').on('click', function () {
        search_plstform();
    });
    $('#pf_keyword').keydown(function (event) {
        if(event.which === 13) {
            search_plstform();
        }
    });
    // 筛选平台
    function search_plstform() {
        json_data = get_platforms();
        json_data = eval('('+json_data+')');
        var platform_list_html = '';
        var platform_html = '';
        var query_json_data = search_json(json_data);
        if (query_json_data.length === 0){
            $('.areabox').addClass('noinfo');
            $('.exception').show();
        } else {
            $.each(query_json_data, function (key, val) {
                platform_html = '';
                platform_html += "<div class='arealist'>";
                platform_html += "<h3>"+ val.name +"</h3><ul>";
                var platform = val.platforms;
                $.each(platform, function (k, v) {
                    platform_html +="<li><a href='http://"+v.domain_name+"' target='_blank'>"+v.pf_name+"</a></li>";
                });
                platform_html += "</ul></div>";
                platform_list_html += platform_html;
            });
            $('.exception').hide();
            $('.areabox').removeClass('noinfo');
        }
        $('.arealistbox').html(platform_list_html);
    }
});

// 地区筛选
function get_region(id, url) {
    var list = [];
    $.ajax({
        async: false,
        type: 'GET',
        url:url,
        data:{id:id},
        success:function (data) {
            list = eval('('+ data + ')');
        }
    });
    return list;
}

function set_city_select() {
    var province_id = $('#nav_province').val();
    var city = get_region(province_id, '/yr/home/ajax_get_city_list');
    var select_html = "<option value='0' selected>市</option>";
    $.each(city, function (k, v) {
        select_html +="<option value='"+v.id+"'>"+v.name+"</option>";
    });
    $('#nav_city').html(select_html);
    $('#nav_area').val(0).html("<option value='0' selected>区</option>");
}

function set_area_select() {
    var city_id = $('#nav_city').val();
    var area = get_region(city_id, '/yr/home/ajax_get_area_list');
    var select_html = "<option value='0' selected>区</option>";
    $.each(area, function (k, v) {
        select_html +="<option value='"+v.id+"'>"+v.name+"</option>";
    });
    $('#nav_area').html(select_html);
}

function get_platforms() {
    var list = '';
    $.ajax({
        async: false,
        type: 'GET',
        url: '/yr/home/ajax_get_platform_region',
        success:function (data) {
            list = data;
        }
    });
    return list;
}

function search_json(json_data) {
    var province_id = $('#nav_province').val();
    var city_id = $('#nav_city').val();
    var area_id = $('#nav_area').val();
    var keyword = $('#pf_keyword').val();

    if (province_id == 0 && city_id == 0 && area_id == 0 && keyword == ''){
        return json_data;
    }
    var query_obj = [];
    var obj_v = [];
    var re =new RegExp("^.*"+keyword+".*$");
    $.each(json_data, function (key, val) {
        obj_v = [];
        $.each(val.platforms, function (k, v) {
            if (province_id != 0 && v.province != province_id){
                return true;
            }
            if (city_id != 0 && v.city != city_id){
                return true;
            }
            if (area_id != 0 && v.district != area_id){
                return true;
            }
            if (!re.test(v.pf_name)){
                return true;
            }
            obj_v.push(v);
        });
        val.platforms = obj_v;
        if (obj_v.length !== 0){
            query_obj.push(val);
        }
    });
    return query_obj;
}